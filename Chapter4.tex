\chapter{Μοντέλα Επίθεσης}
\label{attackModes}

Όταν συζητάμε για κοντέινερς, διακρίνονται δύο οπτικές: 
\emph{μέσα} σε ένα κοντέινερ και \emph{έξω} από αυτό.

Όταν είμαστε \emph{μέσα} σε ένα κοντέινερ, βλέπουμε το κοντέινερ σαν μια
διαδικασία που τρέχει μέσα σε αυτό το κοντέινερ. Αυτή η διαδικασία (και
επομένως η οπτική μας γωνία) έχει απομονωθεί από τον κεντρικό υπολογιστή και μπορεί να
δει μόνο αρχεία και πόρους που αφορούν συγκεκριμένα εκείνο το κοντέινερ. Αυτό
σημαίνει ότι μπορούμε να εκτελούμε εντολές, αλλά μόνο μέσα στο κοντέινερ.

Όταν βρισκόμαστε \emph{έξω} από ένα κοντέινερ, βλέπουμε τον κεντρικό υπολογιστή
και τα κοντέινερ να τρέχουν στο \textlatin{host} σαν μια διαδικασία που
εκτελείται στον κεντρικό υπολογιστή. Μπορούμε να δούμε τα πάντα σε αυτόν τον
κεντρικό υπολογιστή (στον οποίο επίσης έχουμε πρόσβαση). Για παράδειγμα,
μπορούμε να δούμε τη διεργασία \textlatin{Docker daemon} και όλες τις θυγατρικές
διεργασίες της. Είμαστε σε θέση να εκτελέσουμε εντολές απευθείας στον κεντρικό
υπολογιστή. Μπορούμε να χρησιμοποιήσουμε το \textlatin{Docker} (π.χ.
αλληλεπίδραση με κοντέινερς) εάν έχουμε δικαιώματα να χρησιμοποιήσουμε το
\textlatin{Docker}. \\

Μπορούμε να σκεφτούμε αυτές τις οπτικές ως μοντέλα επιτιθέμενων. Ένα μοντέλο
επίθεσης είναι μια γενική αναπαράσταση του πώς ένας εισβολέας θα έκανε επίθεση
σε ένα συγκεκριμένο σύστημα. Επειδή έχουμε δύο οπτικές όταν σκεφτόμαστε τα
κοντέινερ, βλέπουμε δύο μοντέλα επιτιθέμενων.

Μπορούμε να σκεφτούμε την πρώτη οπτική (μέσα σε ένα κοντέινερ) ως ένα μοντέλο
επίθεσης όπου ένας εισβολέας έχει αποκτήσει πρόσβαση σε ένα κοντέινερ.
Ο επιτιθέμενος μπορεί να εκτελεί εντολές μέσα στο κοντέινερ και να έχει
πρόσβαση στα πάντα εντός του κοντέινερ. Επειδή ο επιτιθέμενος θα επικεντρωθεί
κυρίως στην απόδρασή του από την απομόνωση που προσφέρει το κοντέινερ,
ονομάζουμε αυτό το είδος επίθεσης κοντέινερ \textlatin{escapes}.

Μπορούμε να σκεφτούμε τη δεύτερη οπτική (έξω από ένα κοντέινερ) ως ένα
μοντέλο επίθεσης όπου ο επιτιθέμενος έχει μη προνομιούχα πρόσβαση σε έναν
κεντρικό υπολογιστή (\textlatin{host}). Ο επιτιθέμενος είναι σε θέση να
εκτελέσει εντολές στον κεντρικό υπολογιστή, αλλά δεν έχει πρόσβαση
σε όλα. Επειδή ο επιτιθέμενος χρησιμοποιεί το \textlatin{Docker} (συγκεκριμένα
το \textlatin{Docker daemon}) στον κεντρικό υπολογιστή για πρόσβαση,
ονομάζουμε αυτόν τον τύπο επίθεσης "επίθεση στο \textlatin{Docker daemon}".
Αναπτύσσουμε περαιτέρω τις επιθέσεις \textlatin{Docker daemon} σε επόμενη ενότητα.

Στα ακόλουθα κεφάλαια θα συζητήσουμε θέματα ευπάθειας στο \textlatin{Docker}
(κεφάλαιο 4) και τον τρόπο αναγνώρισής τους (κεφάλαιο 5). Θα το κάνουμε αυτό
χρησιμοποιώντας τα μοντέλα επίθεσης αυτού του κεφαλαίου.

Στο παρακάτω σχήμα απεικονίζονται τα μοντέλα επίθεσης.

\begin{figure}[ht]
    \centering
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1]
        % Host Rectangle
        \draw (0,100) -- (400,100) -- (400,130) -- (0,130) -- cycle ;
        \draw (200, 115) node {Κεντρικός Υπολογιστής};

        %Docker Daemon Rectangle
        \draw (200,75) -- (400,75) -- (400,95) -- (200,95) -- cycle ;
        \draw (300,85) node {\textlatin{Docker Daemon}};

        % Process A Rectangle
        \draw (0,40) -- (85,40) -- (85,70) -- (0,70) -- cycle ;
        \draw (42.5,55) node {Διαδικασία 1};

        % Process B Rectangle
        \draw (105,40) -- (190,40) -- (190,70) -- (105,70) -- cycle ;
        \draw (147.5,50) node {Διαδικασία 2};
        \draw (147.5,62.5) node {{\footnotesize (\textlatin{unprivileged})}};

        %Container Process C Rectangle
        \draw (200,0) -- (295,0) -- (295,70) -- (200,70) -- cycle ;
        \draw (247.5,10) node {Κοντέινερ};

        %% Process C Rectangle
        \draw (205,20) -- (290,20) -- (290,50) -- (205,50) -- cycle ;
        \draw (247.5,35) node {Διαδικασία 3};

        %Container Process D Rectangle
        \draw (305,0) -- (400,0) -- (400,70) -- (305,70) -- cycle ;
        \draw (352.5,10) node {Κοντέινερ};

        %% Process D Rectangle
        \draw (310,20) -- (395,20) -- (395,50) -- (310,50) -- cycle ;
        \draw (352.5,35) node {Διαδικασία 4};

    \end{tikzpicture}
    \caption{}\label{fig:attacker-model-empty}
    \medskip
    \small
    Δύο διαδικασίες που τρέχουν απευθείας στο κεντρικό υπολογιστή και δύο οι οποίες τρέχουν μέσα σε \textlatin{Docker} κοντέινερς.
\end{figure}

Οι ακόλουθες διαδικασίες απεικονίζονται στην εικόνα:

\begin{enumerate}
    \item Μια τυπική (προνομιούχα) διαδικασία που εκτελείται απευθείας στον κεντρικό
    υπολογιστή.
    \item Μια τυπική μη προνομιούχα διαδικασία που εκτελείται απευθείας στον κεντρικό
    υπολογιστή.
    \item Μια διεργασία που εκτελείται σε ένα κοντέινερ \textlatin{Docker}.
    \item Όμοια με το 3
\end{enumerate}

\section{Διαφυγές Κοντέινερ \textlatin{Container Escapes}}

Σε μια διαφυγή κοντέινερ, ένας επιτιθέμενος έχει αποκτήσει πρόσβαση σε ένα
κοντέινερ και προσπαθεί να ξεφύγει από την απομόνωσή του. Όταν ένας επιτιθέμενος
αποκτά πρόσβαση σε ένα κοντέινερ, έχει κερδίσει μια βάση μέσα στο στόχο του,
αλλά αυτή η βάση είναι (όπως όλα τα άλλα εντός του κοντέινερ) απομονωμένη από
τον κεντρικό υπολογιστή (\textlatin{host}). Οι διαφυγές κοντέινερ εστίαζουν
στην επίθεση και την παράκαμψη των μηχανισμών απομόνωσης και προστασίας που
διαχωρίζουν το κοντέινερ τόσο από τον κεντρικό υπολογιστή όσο και από άλλα
κοντέινερς.

Στο σχήμα που ακολουθεί βλέπουμε δύο παραλλαγές των αποδράσεων κοντέινερς.
Βλέπουμε τη διαδικασία 3 να έχει πρόσβαση στη διαδικασία 2, η οποία είναι μια
διαδικασία που εκτελείται απευθείας στον κεντρικό υπολογιστή.
Βλέπουμε επίσης τη διαδικασία 3 να αποκτά πρόσβαση στη διαδικασία 4, η οποία
βρίσκεται μέσα σε ένα άλλο κοντέινερ. Και στις δύο περιπτώσεις η διαδικασία 3
διαφεύγει από την απομόνωση του κοντέινερ και αποκτά πρόσβαση σε δεδομένα στα
οποία δεν θα πρέπει να έχει πρόσβαση.

\begin{figure}[ht]
    \centering
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1]
        % Host Rectangle
        \draw (0,100) -- (400,100) -- (400,130) -- (0,130) -- cycle ;
        \draw (200, 115) node {Κεντρικός Υπολογιστής};

        %Docker Daemon Rectangle
        \draw (200,75) -- (400,75) -- (400,95) -- (200,95) -- cycle ;
        \draw (300,85) node {\textlatin{Docker Daemon}};

        % Process A Rectangle
        \draw (0,40) -- (85,40) -- (85,70) -- (0,70) -- cycle ;
        \draw (42.5,55) node {Διαδικασία 1};

        % Process B Rectangle
        \draw (105,40) -- (190,40) -- (190,70) -- (105,70) -- cycle ;
        \draw (147.5,50) node {Διαδικασία 2};
        \draw (147.5,62.5) node {{\footnotesize (\textlatin{unprivileged})}};

        %Container Process C Rectangle
        \draw (200,0) -- (295,0) -- (295,70) -- (200,70) -- cycle ;
        \draw (247.5,10) node {Κοντέινερ};

        %% Process C Rectangle
        \draw (205,20) -- (290,20) -- (290,50) -- (205,50) -- cycle ;
        \draw (247.5,35) node {Διαδικασία 3};

        %Container Process D Rectangle
        \draw (305,0) -- (400,0) -- (400,70) -- (305,70) -- cycle ;
        \draw (352.5,10) node {Κοντέινερ};

        %% Process D Rectangle
        \draw (310,20) -- (395,20) -- (395,50) -- (310,50) -- cycle ;
        \draw (352.5,35) node {Διαδικασία 4};

        % Lines
        \draw [latex-,very thick] (190,55) -- (205,35) ;
        \draw [-latex, very thick] (290,35) -- (310,35) ;
    \end{tikzpicture}
    \caption{}\label{fig:container-escape}
    \medskip
    \small
    Η διαδικασία 3 που τρέχει μέσα σε ένα κοντέινερ έχει πρόσβαση σε δεδομένα
    του κεντρικού υπολογιστή (στα οποία δεν θα έπρεπε να έχει πρόσβαση), στη
    περίπτωση αυτή στη διαδικασία 2.
\end{figure}

Στην πρώτη παραλλαγή, η διαδικασία 3 διαφεύγει από το κοντέινερ για να
αποκτήσει πρόσβαση σε δεδομένα που δεν θα έπρεπε να έχει πρόσβαση στον
κεντρικό υπολογιστή.

Στη δεύτερη παραλλαγή, η διαδικασία 3 δραπετεύει από το κοντέινερ και αποκτά
πρόσβαση σε άλλο κοντέινερ. Τα κοντέινερς δεν πρέπει να απομονώνονται μόνο από
τον κεντρικό υπολογιστή, αλλά και από άλλα κοντέινερς. Αυτό επιτρέπει πολλαπλά
κοντέινερς με ευαίσθητα δεδομένα που εκτελούνται στον ίδιο κεντρικό
υπολογιστή να μην έχουν πρόσβαση το ένα στα δεδομένα του άλλου.

Ένα παράδειγμα σεναρίου επίθεσης θα ήταν μια εταιρεία που προσφέρει μια
πλατφόρμα ως Υπηρεσία (\textlatin{Platform as a Service PaaS}) που επιτρέπει
στους πελάτες να χρησιμοποιούν \textlatin{Docker} κοντέινερ στις υποδομές της
\footnote{Το οποίο είναι αρκέτα σύνηθες στις μέρες μας. Όλοι οι μεγάλοι
υπολογιστικοί πάροχοι προσφέρουν μια τέτοια υπηρεσία}.
Εάν είναι δυνατό για τον εισβολέα να ανεβάσει μια εικόνα \textlatin{Docker}
η οποία περιέχει μια κακόβουλη διαδικασία που διαφεύγει από το κοντέινερ και
έχει πρόσβαση στην υφιστάμενη υποδομή, θα μπορούσε να αποκτήσει πρόσβαση σε άλλα
κοντέινερ ή σε άλλους εσωτερικούς πόρους. Αυτό, προφανώς, θα ήταν μεγάλο
πρόβλημα για την εταιρεία.

Πρέπει να σημειωθεί ότι μια εκμετάλλευση που επιτρέπει σε κάποιον να ξεφύγει
από το \textlatin{Linux namespace} είναι ουσιαστικά μια εκμετάλλευση
διαφυγής κοντέινερ, επειδή το \textlatin{Docker} βασίζεται σε μεγάλο βαθμό σε
χώρους ονομάτων (\textlatin{namespaces}) για απομόνωση.
Η ευπάθεια \textlatin{CVE–2017–7308} \cite{CVE-2017-7308} είναι ένα καλό
παράδειγμα αυτού.

\section{Επιθέσεις \textlatin{Docker Daemon}}

Σε μια επίθεση \textlatin{Docker daemon}, ένας επιτιθέμενος έχει πρόσβαση σε
έναν κεντρικό υπολογιστή με \textlatin{Docker} εγκατεστημένο σε αυτόν. Ο
επιτιθέμενος μπορεί να έχει πρόσβαση σε ευαίσθητα και προνομιούχα στοιχεία και
πληροφορίες, αλληλεπιδρώντας με τον \textlatin{Docker daemon} ή διαβάζοντας τα
αρχεία ρυθμίσεων \textlatin{Docker (configuration files)}. Σε αντίθεση με
τις διαφυγές κοντέινερ, ο επιτιθέμενος δεν επιτίθεται στο \textlatin{Docker}
ή απευθείας στη απομόνωση που δημιουργεί το \textlatin{Docker}, αλλά
χρησιμοποιεί το \textlatin{Docker} για να εκτελέσει κακόβουλες ενέργειες.

Η επίθεση αυτή απεικονίζεται στο παρακάτω σχήμα.

\begin{figure}[ht]
    \centering
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1]
        % Host Rectangle
        \draw (0,100) -- (400,100) -- (400,130) -- (0,130) -- cycle ;
        \draw (200, 115) node {Κεντρικός Υπολογιστής};

        %Docker Daemon Rectangle
        \draw (200,75) -- (400,75) -- (400,95) -- (200,95) -- cycle ;
        \draw (300,85) node {\textlatin{Docker Daemon}};

        % Process A Rectangle
        \draw (0,40) -- (85,40) -- (85,70) -- (0,70) -- cycle ;
        \draw (42.5,55) node {Διαδικασία 1};

        % Process B Rectangle
        \draw (105,40) -- (190,40) -- (190,70) -- (105,70) -- cycle ;
        \draw (147.5,50) node {Διαδικασία 2};
        \draw (147.5,62.5) node {{\footnotesize (\textlatin{unprivileged})}};

        %Container Process C Rectangle
        \draw (200,0) -- (295,0) -- (295,70) -- (200,70) -- cycle ;
        \draw (247.5,10) node {Κοντέινερ};

        %% Process C Rectangle
        \draw (205,20) -- (290,20) -- (290,50) -- (205,50) -- cycle ;
        \draw (247.5,35) node {Διαδικασία 3};

        %Container Process D Rectangle
        \draw (305,0) -- (400,0) -- (400,70) -- (305,70) -- cycle ;
        \draw (352.5,10) node {Κοντέινερ};

        %% Process D Rectangle
        \draw (310,20) -- (395,20) -- (395,50) -- (310,50) -- cycle ;
        \draw (352.5,35) node {Διαδικασία 4};

        % Line
        \draw [-latex, very thick] (147.5,70) -- (200,85) -- (42.5,70);
    \end{tikzpicture}
    \caption{}\label{fig:docker-daemon-attack}
    \medskip
    \small
    Μια διαδικασία χωρίς δικαιώματα (2) αποκτά πρόσβαση σε προνομιούχα δεδομένα
    (διαδικασία 1), χρησιμοποιώντας το \textlatin{Docker Daemon}
\end{figure}

Επειδή το \textlatin{Docker} χρειάζεται πολλές δυνατότητες πυρήνα για να
λειτουργήσει σωστά, o \textlatin{Docker Daemon} πρέπει να εκτελεστεί ως
\texttt{\textlatin{root}}. Αυτό τον καθιστά πολύ ενδιαφέροντα στόχο, επειδή
υπάρχουν τρωτά σημεία που επιτρέπουν σε έναν εισβολέα να ελέγχει με κακόβουλο
τρόπο το \textlatin{Docker} καθώς του επιτρέπει να εκτελεί ενέργειες ως
\texttt{\textlatin{root}}.
